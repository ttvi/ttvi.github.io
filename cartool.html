<!DOCTYPE html>
<html>
<head>
  <title>test data</title>
  <link rel="stylesheet" href="css/examples.css">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
  <script>

    const MAX_COUNT = 10;

    let isCommercial = false;
    let years = 1;
    let provider = "vbi"

    function priceToString(priceString) {
      let result = ""
      const price = Number(priceString)
      const bn = ~~(price / 1000000000)
      if (bn > 0) {
        result += `${bn} ty `
        const ml = ~~((price - bn*1000000000)/1000000)
        result += `${ml} trieu`
      } else {
        const ml = ~~(price / 1000000)
        result += `${ml} trieu`
      }
      return result
    }

    const dict = new Map()
    const keys = new Array()

    console.log("size:", dict.size);
    fetch("/data/index.csv")
      .then(res => res.text())
      .then(text => {
        const lines = text.split(/\r\n|\n/)
        lines.forEach((line, id) => {
          const arr = line.split(/,/)
          dict.set(arr[0].toLowerCase(), arr[1])
          keys.push(arr[0].toLowerCase())
        });
        console.log("size:", dict.size);
      })

    function findMatches(data, q) {
      console.log("query:", q)
      var matches = [];
      // iterate through the pool of strings and for any string that
      // contains the substring `q`, add it to the `matches` array
      data.forEach((str, i) => {
        if (str.indexOf(q) >= 0) {
          matches.push(str);
        }
      });
      return matches;
    };

    const getMapSize = () => {
      const model = document.getElementById("typeaheadinput").value
      console.log("searching for model", model)
      // document.getElementById("demo").innerHTML = priceToString(dict.get(selectedModel));
      var matches = keys;
      model.toLowerCase().split(" ").forEach((item, i) => {
        matches = findMatches(matches, item);
      });

      var result = [];
      matches.forEach((item, i) => {
        result.push(item + " <b>" + priceToString(dict.get(item)) + "</b>")
      });

      document.getElementById("demo").innerHTML = result.join("<br>");
    }

    const forwardForm1 = () => {
      const url = "https://ocr.viettelgroup.ai/_backend/api/ocr/ocrDocument";
      const form = document.forms.formdata;

      const req = new XMLHttpRequest();

      req.addEventListener("progress", updateProgress);
      req.addEventListener("load", transferComplete);
      req.addEventListener("error", transferFailed);
      req.addEventListener("abort", transferCanceled);

      req.open("POST", url, true);
      req.setRequestHeader("Accept", "application/json, text/plain, */*");
      req.setRequestHeader("Accept-Encoding", "gzip, deflate, br");
      req.setRequestHeader("Accept-Language", "en-US,en;q=0.9");
      req.setRequestHeader("Connection", "keep-alive");
      req.setRequestHeader("Cookie", "WEBSVR=1; auth.strategy=local");
      req.setRequestHeader("Host", "ocr.viettelgroup.ai");
      req.setRequestHeader("Sec-Fetch-Dest", "empty");
      req.setRequestHeader("Sec-Fetch-Mode", "no-cors");
      req.setRequestHeader("Sec-Fetch-Site", "cross-site");
      req.setRequestHeader("Access-Control-Allow-Origin", "*");
      // progress on transfers from the server to the client (downloads)
      function updateProgress(event) {
        if (event.lengthComputable) {
          const percentComplete = (event.loaded / event.total) * 100;
          console.log("loading", percentComplete);
        } else {
          // Unable to compute progress information since the total size is unknown
        }
      }

      function transferComplete(evt) {
        console.log("The transfer is complete.");
      }

      function transferFailed(evt) {
        console.log("An error occurred while transferring the file.");
      }

      function transferCanceled(evt) {
        console.log("The transfer has been canceled by the user.");
      }
      req.send(form);
    }

    const forwardForm2 = () => {
      const url = "https://ocr.viettelgroup.ai/_backend/api/ocr/ocrDocument";
      const form = document.forms.formdata;
      const headers = {
        "Accept": "application/json, text/plain, */*",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "en-US,en;q=0.9",
        "Connection": "keep-alive",
        "Cookie": "WEBSVR=1; auth.strategy=local",
        "Host": "ocr.viettelgroup.ai",
        // "Origin": "https://ocr.viettelgroup.ai",
        // "Referer": "https://ocr.viettelgroup.ai/ocrDetails/0",
        // "Sec-Fetch-Dest": "empty",
        // "Sec-Fetch-Mode": "cors",
        // "Sec-Fetch-Site": "same-origin",
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
        "sec-ch-ua": "\"Google Chrome\";v=\"119\", \"Chromium\";v=\"119\", \"Not?A_Brand\";v=\"24\"",
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": "\"macOS\""
      };

      fetch(
          url,
          {
            method:'post',
            mode: "no-cors",
            headers: headers,
            referrerPolicy: "no-referrer",
            body: new FormData(form)
          }
        )
        .then(res => {
            const reader = res.body.getReader();

            return new ReadableStream({
              async start(controller) {
                while (true) {
                  const { done, value } = await reader.read();
                  // When no more data needs to be consumed, break the reading
                  if (done) {
                    break;
                  }
                  // Optionally append the value if you need the full blob later.
                  controller.enqueue(value);
                }

                // Close the stream
                controller.close();
                reader.releaseLock();
              }
            })
          })
          // Create a new response out of the stream (can be avoided?)
          .then(rs => new Response(rs))
          // Create an object URL for the response
          .then(response => response.blob())
          .then(blob => console.log("Do something with full blob", blob))
          .catch(console.error);
        }

    const updateTotalPrice = () => {
      console.log("commercial:", isCommercial);
      console.log("years:", years);
      console.log("provider:", provider);
      document.getElementById("totalPrice").innerHTML = isCommercial ? 100*years : years;
    }

    const commercialCheckBox = (checkbox) => {
      isCommercial = checkbox.checked;
      updateTotalPrice();
    }

    const yearsSelection = (select) => {
      years = select.value;
      updateTotalPrice();
    }

    const providerSelection = (select) => {
      provider = select.value;
      updateTotalPrice();
    }

  </script>

 <h2>HION's used-car pricing tool</h2>
 <p>
   <center>
     <input id="typeaheadinput" class="typeahead" type="text" placeholder="car model to search for"></input>
     <button class="button" type="button" onclick="getMapSize()">Submit</button>
   </center>
   <p id="demo"></p>
   <!-- commercial -->
   <label for="commercial">kinh doanh vận tải:</label>
   <input type="checkbox" id="commercial" name="commercial" onclick="commercialCheckBox(this)">
   <br>
   <!-- years -->
   <label for="years">số năm bảo hiểm:</label>
   <select name="1" id="years" onchange="yearsSelection(this)">
     <option value="1">1</option>
     <option value="2">2</option>
     <option value="3">3</option>
     <option value="4">4</option>
     <option value="5">5</option>
     <option value="6">6</option>
     <option value="7">7</option>
     <option value="8">8</option>
     <option value="9">9</option>
     <option value="10">10</option>
   </select>
   <br>
   <!-- years -->
   <label for="provider">hãng bảo hiểm:</label>
   <select name="pvi" id="provider" onchange="providerSelection(this)">
     <option value="pvi">pvi</option>
     <option value="bvi">bvi</option>
     <option value="bsh">bsh</option>
     <option value="vbi">vbi</option>
   </select>
   <br>
   <!-- total -->
   <label for="totalPrice">total:</label>
   <p id="totalPrice"></p>
 </p>
</body>
</html>
