<!DOCTYPE html>
<html>
<head>
  <title>test data</title>
  <link rel="stylesheet" href="css/examples.css">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://twitter.github.io/typeahead.js/js/handlebars.js"></script>
  <script src="js/typeahead.bundle.js"/></script>

  <script>

    const MAX_COUNT = 10;

    let isCommercial = false;
    let years = 1;
    let provider = "vbi"

    let modelPrice = 0;
    let modelName = "";
    let modelYear = 0;
    let modelAge = 0;

    function priceToString(priceString) {
      let result = ""
      const price = Number(priceString)
      const bn = ~~(price / 1000000000)
      if (bn > 0) {
        result += `${bn} ty `
        const ml = ~~((price - bn*1000000000)/1000000)
        result += `${ml} trieu`
      } else {
        const ml = ~~(price / 1000000)
        result += `${ml} trieu`
      }
      return result
    }

    const dict = new Map()
    const keys = new Array()

    console.log("size:", dict.size);
    fetch("/data/index.csv")
      .then(res => res.text())
      .then(text => {
        const lines = text.split(/\r\n|\n/)
        lines.forEach((line, id) => {
          const arr = line.split(/,/)
          dict.set(arr[0].toLowerCase(), arr[1])
          keys.push(arr[0].toLowerCase())
        });
        console.log("size:", dict.size);
      })

    function findMatches(data, q) {
      console.log("query:", q)
      var matches = [];
      // iterate through the pool of strings and for any string that
      // contains the substring `q`, add it to the `matches` array
      data.forEach((str, i) => {
        if (str.indexOf(q) >= 0) {
          matches.push(str);
        }
      });
      return matches;
    };

    const updateTotalPrice = () => {
      console.log("commercial:", isCommercial);
      console.log("years:", years);
      console.log("provider:", provider);
      document.getElementById("totalPrice").innerHTML = modelPrice*(isCommercial ? 0.012 : 0.011);
    }

    const commercialCheckBox = (checkbox) => {
      isCommercial = checkbox.checked;
      updateTotalPrice();
    }

    const yearsSelection = (select) => {
      years = select.value;
      updateTotalPrice();
    }

    const providerSelection = (select) => {
      provider = select.value;
      updateTotalPrice();
    }

    const refreshModelInfo = (name) => {
      modelName = name;
      modelYear = Number(name.slice(-4));
      modelPrice = dict.get(name);
      modelAge = 2023 - modelYear;

      document.getElementById("model").innerHTML = modelName;
      document.getElementById("year").innerHTML = modelYear;
      document.getElementById("age").innerHTML = modelAge;
      document.getElementById("price").innerHTML = priceToString(modelPrice);
    }

    $(document).ready(function() {
        var substringMatcher = function(strs) {
          return function findTheMatches(q, cb) {
            var matches = keys;
            q.toLowerCase().split(" ").forEach((item, i) => {
              matches = findMatches(matches, item);
            });
            cb(matches);
          }
        };

        $('.typeahead').typeahead({
          hint: true,
          highlight: false,
          minLength: 1
        },
        {
          name: 'states',
          source: substringMatcher(keys)
        });

        $('.typeahead').on('typeahead:selected', function(event, datum) {
          refreshModelInfo(datum);
          updateTotalPrice();
        });
    });

  </script>

 <h2>HION's used-car pricing tool</h2>
 <p>
   <center>
     <input id="typeaheadinput" class="typeahead" type="text" placeholder="car model to search for"></input>
   </center>
   <p id="demo"></p>
   <p>thông tin xe:</p>
   <label for="model">dòng:</label><p id="model"></p>
   <label for="year">năm:</label><p id="year"></p>
   <label for="price">giá:</label><p id="price"></p>
   <label for="age">số năm:</label><p id="age"></p>
   <!-- commercial -->
   <label for="commercial">kinh doanh vận tải:</label>
   <input type="checkbox" id="commercial" name="commercial" onclick="commercialCheckBox(this)">
   <br>
   <!-- years -->
   <label for="years">số năm bảo hiểm:</label>
   <select name="1" id="years" onchange="yearsSelection(this)">
     <option value="1">1</option>
     <option value="2">2</option>
     <option value="3">3</option>
     <option value="4">4</option>
     <option value="5">5</option>
     <option value="6">6</option>
     <option value="7">7</option>
     <option value="8">8</option>
     <option value="9">9</option>
     <option value="10">10</option>
   </select>
   <br>
   <!-- years -->
   <label for="provider">hãng bảo hiểm:</label>
   <select name="pvi" id="provider" onchange="providerSelection(this)">
     <option value="pvi">pvi</option>
     <option value="bvi">bvi</option>
     <option value="bsh">bsh</option>
     <option value="vbi">vbi</option>
   </select>
   <br>
   <!-- total -->
   <label for="totalPrice">total:</label>
   <p id="totalPrice"></p>
 </p>
</body>
</html>
